<!DOCTYPE html>
<html lang="en" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="逐行读取文件的几种方法#
shell编程也是一门学问，虽然功能有限，但要完全掌握它并不容易，甚至比JAVA这样的编程语言更难掌握，因为它考虑了太多的特殊情况，在编写的时候有更多的不确定性。
有一次同事问我，shell里怎样逐行读取一个文件，以处理它，没想到他会被这样的问题给难住。原来他写了一个while语句（从网上搜的）来逐行处理文件，发现这个语句没有像预期的那样执行，写法如下：
[user@node1 ~]$ vim test.sh
#!/bin/bash
 
index=1
while read line
do
	echo &#34;$((index&#43;&#43;)): $line&#34;
	ssh localhost &#34;echo $line &gt;&gt; b.txt&#34;
done &lt; a.txt执行后，只打印出了a.txt中的第一行，当时以为写错了，结果在这个小问题上折腾了很久，再次上网搜索发现原来已很多人也遇到了同样的问题，而且有人已经给出来解释与解决方法。
分析原因#
首先是跟ssh这个命令有关系，因为把ssh那一个行去掉以后就一切正常了。
后来看到有网友说为ssh加上-n选项就可以了，所以特地看了下ssh命令的文档，找到了如下描述：
[user@node1 ~]$ man ssh
...
-n      Redirects stdin from /dev/null (actually, prevents reading from stdin).  This must be used when ssh is run in the background.  A com-
             mon trick is to use this to run X11 programs on a remote machine.  For example, ssh -n shadows.cs.hut.fi emacs &amp; will start an emacs
             on shadows.cs.hut.fi, and the X11 connection will be automatically forwarded over an encrypted channel.  The ssh program will be put
             in the background.  (This does not work if ssh needs to ask for a password or passphrase; see also the -f option.)
...看到这里应该明白了，主要是因为ssh会主动从输入流中读取数据。">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="http://localhost:1313/linux/linux-read-file-by-line.html">
  <meta property="og:site_name" content="橡果笔记">
  <meta property="og:title" content="橡果笔记">
  <meta property="og:description" content="逐行读取文件的几种方法# shell编程也是一门学问，虽然功能有限，但要完全掌握它并不容易，甚至比JAVA这样的编程语言更难掌握，因为它考虑了太多的特殊情况，在编写的时候有更多的不确定性。
有一次同事问我，shell里怎样逐行读取一个文件，以处理它，没想到他会被这样的问题给难住。原来他写了一个while语句（从网上搜的）来逐行处理文件，发现这个语句没有像预期的那样执行，写法如下：
[user@node1 ~]$ vim test.sh #!/bin/bash index=1 while read line do echo &#34;$((index&#43;&#43;)): $line&#34; ssh localhost &#34;echo $line &gt;&gt; b.txt&#34; done &lt; a.txt执行后，只打印出了a.txt中的第一行，当时以为写错了，结果在这个小问题上折腾了很久，再次上网搜索发现原来已很多人也遇到了同样的问题，而且有人已经给出来解释与解决方法。
分析原因# 首先是跟ssh这个命令有关系，因为把ssh那一个行去掉以后就一切正常了。
后来看到有网友说为ssh加上-n选项就可以了，所以特地看了下ssh命令的文档，找到了如下描述：
[user@node1 ~]$ man ssh ... -n Redirects stdin from /dev/null (actually, prevents reading from stdin). This must be used when ssh is run in the background. A com- mon trick is to use this to run X11 programs on a remote machine. For example, ssh -n shadows.cs.hut.fi emacs &amp; will start an emacs on shadows.cs.hut.fi, and the X11 connection will be automatically forwarded over an encrypted channel. The ssh program will be put in the background. (This does not work if ssh needs to ask for a password or passphrase; see also the -f option.) ...看到这里应该明白了，主要是因为ssh会主动从输入流中读取数据。">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="linux">
<title>逐行读取文件的几种方法 | 橡果笔记</title>
<link rel="icon" href="/favicon.png" >
<link rel="manifest" href="/manifest.json">
<link rel="canonical" href="http://localhost:1313/linux/linux-read-file-by-line.html">
<link rel="stylesheet" href="/book.min.c098be6fdb8410d437a0799e694b206fa639685582089c583ae6ac07afec1ff8.css" integrity="sha256-wJi&#43;b9uEENQ3oHmeaUsgb6Y5aFWCCJxYOuasB6/sH/g=" crossorigin="anonymous">


  <script defer src="/fuse.min.js"></script>
  <script defer src="/en.search.min.15cd00d37558f9ebf065bde007abdfcffc678c14a90007173321781d2d1696e0.js" integrity="sha256-Fc0A03VY&#43;evwZb3gB6vfz/xnjBSpAAcXMyF4HS0WluA=" crossorigin="anonymous"></script>

  <script
  async
  src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"
></script>
<meta name="referrer" content="no-referrer-when-downgrade" />
</head>
<body dir="ltr" class="book-kind-page book-type-linux">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    
<aside class="book-menu">
  <div class="book-menu-content">
    
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/index.html"><img src="/favicon.png" alt="Logo" /><span>橡果笔记</span>
  </a>
</h2>


<div class="book-search hidden">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>












  



  
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-c43281baae2cfc496810cc1f0d196095" class="toggle"  />
    <label for="section-c43281baae2cfc496810cc1f0d196095" class="flex">
      <a role="button" class="">
        Atlas Case</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11111.html" class="">
      11111</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11112.html" class="">
      11112</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11113.html" class="">
      11113</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11114.html" class="">
      11114</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11115.html" class="">
      11115</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11116.html" class="">
      11116</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11117.html" class="">
      11117</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11118.html" class="">
      11118</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11119.html" class="">
      11119</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11120.html" class="">
      11120</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11121.html" class="">
      11121</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11122.html" class="">
      11122</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11123.html" class="">
      11123</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11124.html" class="">
      11124</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11125.html" class="">
      11125</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11126.html" class="">
      11126</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11127.html" class="">
      11127</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11128.html" class="">
      11128</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11129.html" class="">
      11129</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11130.html" class="">
      11130</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-12d4232cf896b89b6af3619d86f786b1" class="toggle"  />
    <label for="section-12d4232cf896b89b6af3619d86f786b1" class="flex">
      <a role="button" class="">
        Golang</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/golang/find-index-in-cycle-array.html" class="">
      在循环数组中找出索引</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/golang/golang-get-package-to-dir.html" class="">
      下载包到指定目录</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/golang/golang-grpc-demo.html" class="">
      gRPC使用指南</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/golang/golang-profiler.html" class="">
      应用性能分析</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/golang/golang-regexp-performance.html" class="">
      正则性能优化</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/golang/golang-tls-web.html" class="">
      web应用开发</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/golang/golang-web-and-curl.html" class="">
      解析客户端参数</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/golang/unicode-to-zh.html" class="">
      unicode转中文</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-b0c7fc0f44fa6f9b2b6b2aaa166d103d" class="toggle"  />
    <label for="section-b0c7fc0f44fa6f9b2b6b2aaa166d103d" class="flex">
      <a role="button" class="">
        Java</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/java/java-from-class-to-machine-code.html" class="">
      Java - 从CLASS到机器码</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/java/java-nio-frame.html" class="">
      Java - NIO框架</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/java/netty-guide.html" class="">
      Java - Netty入门</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-1fba834cea86f65b73a207a4c7222a69" class="toggle" checked />
    <label for="section-1fba834cea86f65b73a207a4c7222a69" class="flex">
      <a role="button" class="">
        Linux</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/linux/linux-centos7-multi-ip.html" class="">
      Centos7增加子IP</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/linux/linux-parallel-progress.html" class="">
      炫酷的并行进度条</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/linux/linux-pipe-redirect.html" class="">
      管道与重定向详解</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/linux/linux-read-file-by-line.html" class="active">
      逐行读取文件的几种方法</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/linux/linux-resolve-iptables.html" class="">
      理解iptables</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/linux/linux-send-mail.html" class="">
      发送邮件的两种方式</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-a678cfd4d00720650628dd6c008f4ee1" class="toggle"  />
    <label for="section-a678cfd4d00720650628dd6c008f4ee1" class="flex">
      <a role="button" class="">
        健康管理</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-d037bff0aa1de2c37d870a73480bbe84" class="toggle"  />
    <label for="section-d037bff0aa1de2c37d870a73480bbe84" class="flex">
      <a role="button" class="">
        大数据</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/bigdata/ambari-quick-build-bigdata-platform.html" class="">
      Ambari - 三条命令创建集群</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/bigdata/bigdate-on-docker.html" class="">
      Bigdata on Docker</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/bigdata/bigdate-on-kubernetes.html" class="">
      Bigdata on Kubernetes</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/bigdata/spark-performance-optimiz.html" class="">
      Spark on Yarn - 性能调优</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/bigdata/spark-performance-test.html" class="">
      Spark - 性能测试</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/bigdata/spark-source-code-1.html" class="">
      Spark - 源码分析（一）</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/bigdata/spark-source-code-2.html" class="">
      Spark - 源码分析（二）</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/bigdata/spark-source-code-3.html" class="">
      Spark - 源码分析（三）</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/bigdata/spark-source-code-4.html" class="">
      Spark – 源码分析（四）</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/bigdata/spark-source-code-5.html" class="">
      Spark - 源码分析（图）</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/bigdata/spark-thrift-mode.html" class="">
      Spark - Thrift Server模式</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-91c0d79a971e1d12f575b6033d9c8855" class="toggle"  />
    <label for="section-91c0d79a971e1d12f575b6033d9c8855" class="flex">
      <a role="button" class="">
        容器开发</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-auto-test-product.html" class="">
      产品自动化测试</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-bigdata-develope.html" class="">
      与大数据平台开发</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-build-centos65.html" class="">
      手工构建基础镜像</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-code-create-container.html" class="">
      DOCKER源码-创建容器</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-code-create-network.html" class="">
      DOCKER源码-创建网络</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-code-start-dockerd.html" class="">
      DOCKER源码-启动流程</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-config-direct-lvm.html" class="">
      配置direct-lvm</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-dynamic-port-map.html" class="">
      动态映射端口</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-multi-host-with-zk.html" class="">
      多主机通信之ZK</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-registry-deploy-manage.html" class="">
      私有仓库的搭建与管理</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-with-glusterfs.html" class="">
      数据持久化之GlusterFS</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/k8s-calico.html" class="">
      calico网络</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/k8s-cni.html" class="">
      k8s CNI</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/k8s-code-apiserver-start.html" class="">
      k8s源码分析-apiserver</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/k8s-code-kubelet.html" class="">
      k8s源码分析-kubelet</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/k8s-code-pod-create.html" class="">
      k8s源码分析-创建Pod流程</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/k8s-code-scheduler-start.html" class="">
      k8s源码分析-scheduler</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/k8s-cri.html" class="">
      k8s CRI</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/k8s-dashboard-with-heapster.html" class="">
      k8s 仪表盘与性能指标</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/k8s-expose-service.html" class="">
      k8s 暴露服务</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/k8s-principle.html" class="">
      k8s 基本原理</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/kubeedge-code.html" class="">
      KubeEdge源码分析</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/kubernetes-quick-deloy-17.html" class="">
      k8s 快速部署 1.7</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/kubernetes-quick-deloy.html" class="">
      k8s 快速部署 1.5</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/popular-bgp-protocol.html" class="">
      白话BGP协议</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-c5d12fc3b068a833366514cb64f8d255" class="toggle"  />
    <label for="section-c5d12fc3b068a833366514cb64f8d255" class="flex">
      <a role="button" class="">
        开发工具</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/develop-tool/git.html" class="">
      GIT常用命令</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/develop-tool/jq.html" class="">
      JQ命令</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/develop-tool/vscode.html" class="">
      vscode for go</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-6149a7124e796953d79adfd27cbd4453" class="toggle"  />
    <label for="section-6149a7124e796953d79adfd27cbd4453" class="flex">
      <a role="button" class="">
        数据结构与算法</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/algorithm/algorithm-collaborative-filtering.html" class="">
      推荐算法 - 协同过滤</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/algorithm/algorithm-naive-bayes.html" class="">
      分类算法 - 朴素贝叶斯</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/algorithm/algorithm-quick-sort.html" class="">
      排序算法 - 快速排序</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-67c69527106b60d0276c1da79ec8b117" class="toggle"  />
    <label for="section-67c69527106b60d0276c1da79ec8b117" class="flex">
      <a role="button" class="">
        架构设计</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/architecture/cloud-plateform-loadbalancer.html" class="">
      云平台 - 负载均衡器</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-d3df18c0319f8ea7ade159d66b647170" class="toggle"  />
    <label for="section-d3df18c0319f8ea7ade159d66b647170" class="flex">
      <a role="button" class="">
        网络编程</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/network/tcp-theory.html" class="">
      TCP原理</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>













</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>



  </div>
</aside>
 

    <div class="book-page">
      <header class="book-header hidden">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/icons/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>逐行读取文件的几种方法</h3>

  <label for="toc-control">
    
    <img src="/icons/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#分析原因">分析原因</a></li>
        <li><a href="#几种可行的方法">几种可行的方法</a></li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown book-article"><h1 id="逐行读取文件的几种方法">逐行读取文件的几种方法<a class="anchor" href="#%e9%80%90%e8%a1%8c%e8%af%bb%e5%8f%96%e6%96%87%e4%bb%b6%e7%9a%84%e5%87%a0%e7%a7%8d%e6%96%b9%e6%b3%95">#</a></h1>
<p>shell编程也是一门学问，虽然功能有限，但要完全掌握它并不容易，甚至比JAVA这样的编程语言更难掌握，因为它考虑了太多的特殊情况，在编写的时候有更多的不确定性。</p>
<p>有一次同事问我，shell里怎样逐行读取一个文件，以处理它，没想到他会被这样的问题给难住。原来他写了一个while语句（从网上搜的）来逐行处理文件，发现这个语句没有像预期的那样执行，写法如下：</p>
<pre tabindex="0"><code>[user@node1 ~]$ vim test.sh
#!/bin/bash
 
index=1
while read line
do
	echo &#34;$((index++)): $line&#34;
	ssh localhost &#34;echo $line &gt;&gt; b.txt&#34;
done &lt; a.txt</code></pre><p>执行后，只打印出了a.txt中的第一行，当时以为写错了，结果在这个小问题上折腾了很久，再次上网搜索发现原来已很多人也遇到了同样的问题，而且有人已经给出来解释与解决方法。</p>
<h3 id="分析原因">分析原因<a class="anchor" href="#%e5%88%86%e6%9e%90%e5%8e%9f%e5%9b%a0">#</a></h3>
<p>首先是跟ssh这个命令有关系，因为把ssh那一个行去掉以后就一切正常了。</p>
<p>后来看到有网友说为ssh加上-n选项就可以了，所以特地看了下ssh命令的文档，找到了如下描述：</p>
<pre tabindex="0"><code>[user@node1 ~]$ man ssh
...
-n      Redirects stdin from /dev/null (actually, prevents reading from stdin).  This must be used when ssh is run in the background.  A com-
             mon trick is to use this to run X11 programs on a remote machine.  For example, ssh -n shadows.cs.hut.fi emacs &amp; will start an emacs
             on shadows.cs.hut.fi, and the X11 connection will be automatically forwarded over an encrypted channel.  The ssh program will be put
             in the background.  (This does not work if ssh needs to ask for a password or passphrase; see also the -f option.)
...</code></pre><p>看到这里应该明白了，主要是因为ssh会主动从输入流中读取数据。</p>
<p>现在我们来完整地分析一下这个语句执行的过程，首先a.txt的内容会全部重定向到stdin中等待其它程序读取，这时所有内容中的\n还是存在的，在调用read命令时会以\n为结束符，每次读取一行，这时echo命令把这一行内容给打印出来，而到了ssh这一行的时候，ssh命令会主动从stdin中读出所有内容（就像read命令一样），但它不把\n当做结束符，所以就读取了剩下的所有数据，所以到while第二次循环时，stdin中已经没有数据了，这时跳出循环，执行结束。</p>
<p>为ssh加上-n选项并不是一个完美的解决方法，因为假如while中还有其它类似的命令呢？又要被坑一次，那用for语句行不行呢？就像下面这样：</p>
<pre tabindex="0"><code>[user@node1 ~]$ vi test.sh
#!/bin/bash
 
index=1
for line in `cat a.txt`
do
	echo &#34;$((index++)): $line&#34;
	ssh -n localhost &#34;cat&#34;
done</code></pre><p>这样还是不行的，因为for line in语句每次读取数据是以系统IFS为结束符的，而IFS包括空格，这意味着如果a.txt中有空格，for语句也就不能逐行读取了。</p>
<h3 id="几种可行的方法">几种可行的方法<a class="anchor" href="#%e5%87%a0%e7%a7%8d%e5%8f%af%e8%a1%8c%e7%9a%84%e6%96%b9%e6%b3%95">#</a></h3>
<p>如果只是对文件做一些简单的操作，为ssh加上-n选项就是一个很好的解决方法，因为大多数人对while的用法足够了解：</p>
<pre tabindex="0"><code>[user@node1 ~]$ vi test.sh
#!/bin/bash
 
index=1
while read line
do
	echo &#34;$((index++)): $line&#34;
	ssh -n localhost &#34;echo $line &gt;&gt; b.txt&#34;
done &lt; a.txt</code></pre><p>如果要处理的文件不是很大，也可以用sed命令来处理，看起来更简单，如果文件太大，性能当然会有损耗了：</p>
<pre tabindex="0"><code>[user@node1 ~]$ vi test.sh
#!/bin/bash
 
count=`cat a.txt | wc -l`
for i in `seq 1 $count`
do
    line=`sed -n &#34;${i}p&#34; a.txt`
    echo $line
done</code></pre><p>还可以head命令加tail命令，如果文件太大，这种方式的性能损耗会更明显，不过几百行的小文件还是看不出损耗的啦：</p>
<pre tabindex="0"><code>[user@node1 ~]$ vi test.sh
#!/bin/bash
 
count=`cat a.txt | wc -l`
for i in `seq 1 $count`
do
    line=`head -n $i | tail -n 1`
    echo $line
done</code></pre><p>还可以用强大的awk命令，好像有点大材小用了，=_=!</p>
<pre tabindex="0"><code>[user@node1 ~]$ vi test.sh
#!/bin/bash
 
count=`cat a.txt | wc -l`
for i in `seq 1 $count`
do
    line=`awk &#34;NR==$i&#34; a.txt`
    echo $line
done</code></pre><p>当然还有xargs命令啦，性能会比sed和awk强些，不过它后面一般只接一个命令，如果操作比较复杂的话，可能满足不了你：</p>
<pre tabindex="0"><code>cat a.txt | xargs -I _LINE ssh localhost &#34;echo _LINE &gt; b.txt&#34;</code></pre><p>对上面的方法稍加修改，可以在xargs后面接多个命令，不过依然不太适合复杂的操作：</p>
<pre tabindex="0"><code>cat a.txt | xargs -I _LINE bash -c &#39;line=&#34;_LINE&#34; ; ssh hostname1 &#34;echo $line &gt; b.txt&#34; ; ssh hostname2 &#34;echo $line &gt; b.txt&#34; &#39;</code></pre><p>好吧，先就写这么多，如果以后发现其它更好的方法再写上来。</p>
</article>
 
      <br/>
<hr/>


      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">

<div>

</div>

<div>

</div>

</div>



  



  
  
  
  <div class="flex flex-wrap justify-between">
    <span>
    
      <a href="/linux/linux-pipe-redirect.html" class="flex align-center">
        <img src="/icons/backward.svg" class="book-icon" alt="Previous" title="管道与重定向详解" />
        <span>管道与重定向详解</span>
      </a>
    
    </span>
    <span>
    
      <a href="/linux/linux-resolve-iptables.html" class="flex align-center">
        <span>理解iptables</span>
        <img src="/icons/forward.svg" class="book-icon" alt="Next" title="理解iptables" />
      </a>
    
    </span>
  </div>
  




  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
  
  <div class="book-comments">

</div>
  
 
        <br/>


<div class="busuanzi-footer">
<span class="split"> · </span>
<span>
  <span id="busuanzi_container_page_pv">本文阅读量<span id="busuanzi_value_page_pv"></span>次</span>
</span>
<span class="split"> · </span>
  <span id="busuanzi_container_site_pv">
    本站总访问量<span id="busuanzi_value_site_pv"></span>次
  </span>
<span class="split"> · </span>
  <span id="busuanzi_container_site_uv">
    本站访客数<span id="busuanzi_value_site_uv"></span>人次
  </span>
</div>


<p><a href="http://creativecommons.org/licenses/by-nc-nd/3.0/cn/"><img src="https://licensebuttons.net/l/by-nc-nd/3.0/cn/88x31.png" /></a>
本站所有作品均采用<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/cn/">知识共享署名-非商业性使用-禁止演绎 3.0 中国大陆许可协议</a>进行许可。</p>

        

 
      </footer>

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    

<aside class="book-toc">
  <div class="book-toc-content">
    
  
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#分析原因">分析原因</a></li>
        <li><a href="#几种可行的方法">几种可行的方法</a></li>
      </ul>
    </li>
  </ul>
</nav>



  </div>
</aside>

 
  </main>

  
</body>
</html>



















<!DOCTYPE html>
<html lang="en" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="理解iptables#
iptables是Linux系统中的一个命令，也是Linux系统上最常用的防火墙，我们常见的Linux发行版如：CentOS、Ubuntu等都是用iptables作为默认的防火墙，它的强大之处在于它可以控制所有进出系统的数据包。然而，对于初次接触它的人来说，这是个比较难用的命令，不止一个人问过我怎样写一条阻止某IP的命令，因为用它增加一条防火墙规则可能需要写一条很长的命令，如果你没有了解它的工作原理，是写不出一条完整的iptables命令的。本文将剖析它的工作原理并结合例子让你更容易使用它。
前提工作#
要了解iptables就先要了解数据包，这里说的数据包指的是在网络中传输的数据包，又名：报文，如果你了解过TCP协议并写过相关的代码，那么这个词应该不会陌生，如果你不了也没关系，我们这就来谈一谈这个数据包的概念。

其实这个数据包的结构又要用到七层协议的概念，真是一环扣一环，这里我就且当你了解七层协议的概念，如果真的不懂可以先去看看《鸟哥的Linux私房菜》，不过我会尽量讲的通俗一些，希望这不会影响到你阅读下文。网络传输#
设有两台电脑A与B，A通过网络发送一个文件给B，这个文件会被切分成一个一个的小数据包，每个数据包大小约 1KB 左右，然后转成二进制码按顺序发出去，在网络中以电讯号的形式传输给B，B接收到以后再将这些二进制码转成数据包，最后组合成一个文件。
封包表头#
数据包也称为封包，一个完整的封包，除了我们需要发送的内容以外还包含了很多额外信息，也就是封包表头，主要用来标记这个数据包“从哪里来到哪里去”，在上例中，如果AB相距较远的话，中间一般会经过多个路由器和交换机，当然还有网卡网线等。。。当一个封包经过途中每个设备时，这些设备都需要读出这些封包的表头，才能知道这个封包要去哪里，然后再发给对应的设备，下一个设备收到这个封包也是一样，最终到达了B，可以说封包表头与数据本身同等重要。
封包格式#
实际上，每个数据包外面套了三层封包，每层都是不同的格式，用来给不同的设备读取。如果以TCP作为传输协议，这三层封包分别为：MAC封包、IP封包、TPC封包，用下图来说明它们的关系：

图中只是简单的列出每个封包表头中较关键的信息，其实还有很多其它信息，比如TCP封包表头中的序列号、状态码，每种封包的详细格式，这里就不展开说明了，不然的话就有点跑题了。如果想深入了解的话网上有很多相关资料。
iptables中的表（table）#
终于说到正点了，，iptables的原理正是分析每个封包的表头，然后根据我们设定的防火墙规则作出相应的动作。 在iptables中有表的概念，使用的时候一般用默认的表，需要的话也可以自己建表，在CentOS6.5中默认有四张表：filter、nat、mangle、raw，每张表有不同的作用:

filter 表的作用就是防火墙
nat 表是用来作数据转发
mangle 表专门对特定数据包进处理
raw 表也是在特殊情况下用的，可以减少iptabls对性能的影响

前两个表是常用的表，后两个用的很少，而且博主一直没有用过，本文只对前两个表进行介绍。
表中的链（chains）#
上面的每张表中都有多个链，链可以理解为小表，每个小表用来处理不同的情况，在filter表中，默认有三个小表：

INPUT 进入本机的封包要经过此链
OUTPUT 从本机发出的封包要经过此链
FORWARD 经过nat表后目标不是本机的封包会经过此链

在nat表中，默认也有三个小表：

PREROUTING 封包进入本机时要先经过此链
POSTROUTING 封包从本机发送出去之前要经过此链
OUTPUT 经filter表过滤后的封包会经过此链

由此可以看出，数据包在经过这些链时，是有先后顺序的，而且每张表也是有关联的，如果我们只考虑filter表和nat表，那么封包在通过iptables时的顺序大致如下：  上图中需要注意的是，nat表中的PREROUTING链，nat是用来做数据转发的，它可以修改封包表头中的内容，假设我在PREROUTING链中写入一条规则：将目标为本机的封包转发到 137.137.0.200 这个IP上，这样当封包从PREROUTING链出来后，就不走图中的第二步，而是会经上图中的两条黄线，直接被送出本机。
链中的规则（rule）#
每个小表中可以有多条规则，经过此小表的封包要符合此小表上的每条规则，最后才能通过，以filter表为例：
[root@blog ~]# iptables -t filter -n -L
Chain INPUT (policy DROP)
target     prot opt source               destination         
REJECT     all  --  191.96.249.0/24      0.0.0.0/0            reject-with icmp-port-unreachable
ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:22
ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:80
 
Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         
 
Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination 命令说明：">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="http://localhost:1313/linux/linux-resolve-iptables.html">
  <meta property="og:site_name" content="橡果笔记">
  <meta property="og:title" content="橡果笔记">
  <meta property="og:description" content="理解iptables# iptables是Linux系统中的一个命令，也是Linux系统上最常用的防火墙，我们常见的Linux发行版如：CentOS、Ubuntu等都是用iptables作为默认的防火墙，它的强大之处在于它可以控制所有进出系统的数据包。然而，对于初次接触它的人来说，这是个比较难用的命令，不止一个人问过我怎样写一条阻止某IP的命令，因为用它增加一条防火墙规则可能需要写一条很长的命令，如果你没有了解它的工作原理，是写不出一条完整的iptables命令的。本文将剖析它的工作原理并结合例子让你更容易使用它。
前提工作# 要了解iptables就先要了解数据包，这里说的数据包指的是在网络中传输的数据包，又名：报文，如果你了解过TCP协议并写过相关的代码，那么这个词应该不会陌生，如果你不了也没关系，我们这就来谈一谈这个数据包的概念。
其实这个数据包的结构又要用到七层协议的概念，真是一环扣一环，这里我就且当你了解七层协议的概念，如果真的不懂可以先去看看《鸟哥的Linux私房菜》，不过我会尽量讲的通俗一些，希望这不会影响到你阅读下文。
网络传输# 设有两台电脑A与B，A通过网络发送一个文件给B，这个文件会被切分成一个一个的小数据包，每个数据包大小约 1KB 左右，然后转成二进制码按顺序发出去，在网络中以电讯号的形式传输给B，B接收到以后再将这些二进制码转成数据包，最后组合成一个文件。
封包表头# 数据包也称为封包，一个完整的封包，除了我们需要发送的内容以外还包含了很多额外信息，也就是封包表头，主要用来标记这个数据包“从哪里来到哪里去”，在上例中，如果AB相距较远的话，中间一般会经过多个路由器和交换机，当然还有网卡网线等。。。当一个封包经过途中每个设备时，这些设备都需要读出这些封包的表头，才能知道这个封包要去哪里，然后再发给对应的设备，下一个设备收到这个封包也是一样，最终到达了B，可以说封包表头与数据本身同等重要。
封包格式# 实际上，每个数据包外面套了三层封包，每层都是不同的格式，用来给不同的设备读取。如果以TCP作为传输协议，这三层封包分别为：MAC封包、IP封包、TPC封包，用下图来说明它们的关系： 图中只是简单的列出每个封包表头中较关键的信息，其实还有很多其它信息，比如TCP封包表头中的序列号、状态码，每种封包的详细格式，这里就不展开说明了，不然的话就有点跑题了。如果想深入了解的话网上有很多相关资料。
iptables中的表（table）# 终于说到正点了，，iptables的原理正是分析每个封包的表头，然后根据我们设定的防火墙规则作出相应的动作。 在iptables中有表的概念，使用的时候一般用默认的表，需要的话也可以自己建表，在CentOS6.5中默认有四张表：filter、nat、mangle、raw，每张表有不同的作用:
filter 表的作用就是防火墙 nat 表是用来作数据转发 mangle 表专门对特定数据包进处理 raw 表也是在特殊情况下用的，可以减少iptabls对性能的影响 前两个表是常用的表，后两个用的很少，而且博主一直没有用过，本文只对前两个表进行介绍。
表中的链（chains）# 上面的每张表中都有多个链，链可以理解为小表，每个小表用来处理不同的情况，在filter表中，默认有三个小表：
INPUT 进入本机的封包要经过此链 OUTPUT 从本机发出的封包要经过此链 FORWARD 经过nat表后目标不是本机的封包会经过此链 在nat表中，默认也有三个小表：
PREROUTING 封包进入本机时要先经过此链 POSTROUTING 封包从本机发送出去之前要经过此链 OUTPUT 经filter表过滤后的封包会经过此链 由此可以看出，数据包在经过这些链时，是有先后顺序的，而且每张表也是有关联的，如果我们只考虑filter表和nat表，那么封包在通过iptables时的顺序大致如下： 上图中需要注意的是，nat表中的PREROUTING链，nat是用来做数据转发的，它可以修改封包表头中的内容，假设我在PREROUTING链中写入一条规则：将目标为本机的封包转发到 137.137.0.200 这个IP上，这样当封包从PREROUTING链出来后，就不走图中的第二步，而是会经上图中的两条黄线，直接被送出本机。
链中的规则（rule）# 每个小表中可以有多条规则，经过此小表的封包要符合此小表上的每条规则，最后才能通过，以filter表为例：
[root@blog ~]# iptables -t filter -n -L Chain INPUT (policy DROP) target prot opt source destination REJECT all -- 191.96.249.0/24 0.0.0.0/0 reject-with icmp-port-unreachable ACCEPT tcp -- 0.0.0.0/0 0.0.0.0/0 tcp dpt:22 ACCEPT tcp -- 0.0.0.0/0 0.0.0.0/0 tcp dpt:80 Chain FORWARD (policy ACCEPT) target prot opt source destination Chain OUTPUT (policy ACCEPT) target prot opt source destination 命令说明：">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="linux">
<title>理解iptables | 橡果笔记</title>
<link rel="icon" href="/favicon.png" >
<link rel="manifest" href="/manifest.json">
<link rel="canonical" href="http://localhost:1313/linux/linux-resolve-iptables.html">
<link rel="stylesheet" href="/book.min.c098be6fdb8410d437a0799e694b206fa639685582089c583ae6ac07afec1ff8.css" integrity="sha256-wJi&#43;b9uEENQ3oHmeaUsgb6Y5aFWCCJxYOuasB6/sH/g=" crossorigin="anonymous">


  <script defer src="/fuse.min.js"></script>
  <script defer src="/en.search.min.15cd00d37558f9ebf065bde007abdfcffc678c14a90007173321781d2d1696e0.js" integrity="sha256-Fc0A03VY&#43;evwZb3gB6vfz/xnjBSpAAcXMyF4HS0WluA=" crossorigin="anonymous"></script>

  <script
  async
  src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"
></script>
<meta name="referrer" content="no-referrer-when-downgrade" />
</head>
<body dir="ltr" class="book-kind-page book-type-linux">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    
<aside class="book-menu">
  <div class="book-menu-content">
    
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/index.html"><img src="/favicon.png" alt="Logo" /><span>橡果笔记</span>
  </a>
</h2>


<div class="book-search hidden">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>












  



  
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-c43281baae2cfc496810cc1f0d196095" class="toggle"  />
    <label for="section-c43281baae2cfc496810cc1f0d196095" class="flex">
      <a role="button" class="">
        Atlas Case</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11111.html" class="">
      11111</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11112.html" class="">
      11112</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11113.html" class="">
      11113</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11114.html" class="">
      11114</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11115.html" class="">
      11115</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11116.html" class="">
      11116</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11117.html" class="">
      11117</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11118.html" class="">
      11118</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11119.html" class="">
      11119</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11120.html" class="">
      11120</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11121.html" class="">
      11121</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11122.html" class="">
      11122</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11123.html" class="">
      11123</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11124.html" class="">
      11124</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11125.html" class="">
      11125</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11126.html" class="">
      11126</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11127.html" class="">
      11127</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11128.html" class="">
      11128</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11129.html" class="">
      11129</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11130.html" class="">
      11130</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-12d4232cf896b89b6af3619d86f786b1" class="toggle"  />
    <label for="section-12d4232cf896b89b6af3619d86f786b1" class="flex">
      <a role="button" class="">
        Golang</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/golang/find-index-in-cycle-array.html" class="">
      在循环数组中找出索引</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/golang/golang-get-package-to-dir.html" class="">
      下载包到指定目录</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/golang/golang-grpc-demo.html" class="">
      gRPC使用指南</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/golang/golang-profiler.html" class="">
      应用性能分析</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/golang/golang-regexp-performance.html" class="">
      正则性能优化</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/golang/golang-tls-web.html" class="">
      web应用开发</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/golang/golang-web-and-curl.html" class="">
      解析客户端参数</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/golang/unicode-to-zh.html" class="">
      unicode转中文</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-b0c7fc0f44fa6f9b2b6b2aaa166d103d" class="toggle"  />
    <label for="section-b0c7fc0f44fa6f9b2b6b2aaa166d103d" class="flex">
      <a role="button" class="">
        Java</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/java/java-from-class-to-machine-code.html" class="">
      Java - 从CLASS到机器码</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/java/java-nio-frame.html" class="">
      Java - NIO框架</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/java/netty-guide.html" class="">
      Java - Netty入门</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-1fba834cea86f65b73a207a4c7222a69" class="toggle" checked />
    <label for="section-1fba834cea86f65b73a207a4c7222a69" class="flex">
      <a role="button" class="">
        Linux</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/linux/linux-centos7-multi-ip.html" class="">
      Centos7增加子IP</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/linux/linux-parallel-progress.html" class="">
      炫酷的并行进度条</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/linux/linux-pipe-redirect.html" class="">
      管道与重定向详解</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/linux/linux-read-file-by-line.html" class="">
      逐行读取文件的几种方法</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/linux/linux-resolve-iptables.html" class="active">
      理解iptables</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/linux/linux-send-mail.html" class="">
      发送邮件的两种方式</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-a678cfd4d00720650628dd6c008f4ee1" class="toggle"  />
    <label for="section-a678cfd4d00720650628dd6c008f4ee1" class="flex">
      <a role="button" class="">
        健康管理</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-d037bff0aa1de2c37d870a73480bbe84" class="toggle"  />
    <label for="section-d037bff0aa1de2c37d870a73480bbe84" class="flex">
      <a role="button" class="">
        大数据</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/bigdata/ambari-quick-build-bigdata-platform.html" class="">
      Ambari - 三条命令创建集群</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/bigdata/bigdate-on-docker.html" class="">
      Bigdata on Docker</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/bigdata/bigdate-on-kubernetes.html" class="">
      Bigdata on Kubernetes</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/bigdata/spark-performance-optimiz.html" class="">
      Spark on Yarn - 性能调优</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/bigdata/spark-performance-test.html" class="">
      Spark - 性能测试</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/bigdata/spark-source-code-1.html" class="">
      Spark - 源码分析（一）</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/bigdata/spark-source-code-2.html" class="">
      Spark - 源码分析（二）</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/bigdata/spark-source-code-3.html" class="">
      Spark - 源码分析（三）</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/bigdata/spark-source-code-4.html" class="">
      Spark – 源码分析（四）</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/bigdata/spark-source-code-5.html" class="">
      Spark - 源码分析（图）</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/bigdata/spark-thrift-mode.html" class="">
      Spark - Thrift Server模式</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-91c0d79a971e1d12f575b6033d9c8855" class="toggle"  />
    <label for="section-91c0d79a971e1d12f575b6033d9c8855" class="flex">
      <a role="button" class="">
        容器开发</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-auto-test-product.html" class="">
      产品自动化测试</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-bigdata-develope.html" class="">
      与大数据平台开发</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-build-centos65.html" class="">
      手工构建基础镜像</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-code-create-container.html" class="">
      DOCKER源码-创建容器</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-code-create-network.html" class="">
      DOCKER源码-创建网络</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-code-start-dockerd.html" class="">
      DOCKER源码-启动流程</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-config-direct-lvm.html" class="">
      配置direct-lvm</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-dynamic-port-map.html" class="">
      动态映射端口</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-multi-host-with-zk.html" class="">
      多主机通信之ZK</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-registry-deploy-manage.html" class="">
      私有仓库的搭建与管理</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-with-glusterfs.html" class="">
      数据持久化之GlusterFS</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/k8s-calico.html" class="">
      calico网络</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/k8s-cni.html" class="">
      k8s CNI</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/k8s-code-apiserver-start.html" class="">
      k8s源码分析-apiserver</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/k8s-code-kubelet.html" class="">
      k8s源码分析-kubelet</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/k8s-code-pod-create.html" class="">
      k8s源码分析-创建Pod流程</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/k8s-code-scheduler-start.html" class="">
      k8s源码分析-scheduler</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/k8s-cri.html" class="">
      k8s CRI</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/k8s-dashboard-with-heapster.html" class="">
      k8s 仪表盘与性能指标</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/k8s-expose-service.html" class="">
      k8s 暴露服务</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/k8s-principle.html" class="">
      k8s 基本原理</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/kubeedge-code.html" class="">
      KubeEdge源码分析</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/kubernetes-quick-deloy-17.html" class="">
      k8s 快速部署 1.7</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/kubernetes-quick-deloy.html" class="">
      k8s 快速部署 1.5</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/popular-bgp-protocol.html" class="">
      白话BGP协议</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-c5d12fc3b068a833366514cb64f8d255" class="toggle"  />
    <label for="section-c5d12fc3b068a833366514cb64f8d255" class="flex">
      <a role="button" class="">
        开发工具</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/develop-tool/git.html" class="">
      GIT常用命令</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/develop-tool/jq.html" class="">
      JQ命令</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/develop-tool/vscode.html" class="">
      vscode for go</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-6149a7124e796953d79adfd27cbd4453" class="toggle"  />
    <label for="section-6149a7124e796953d79adfd27cbd4453" class="flex">
      <a role="button" class="">
        数据结构与算法</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/algorithm/algorithm-collaborative-filtering.html" class="">
      推荐算法 - 协同过滤</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/algorithm/algorithm-naive-bayes.html" class="">
      分类算法 - 朴素贝叶斯</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/algorithm/algorithm-quick-sort.html" class="">
      排序算法 - 快速排序</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-67c69527106b60d0276c1da79ec8b117" class="toggle"  />
    <label for="section-67c69527106b60d0276c1da79ec8b117" class="flex">
      <a role="button" class="">
        架构设计</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/architecture/cloud-plateform-loadbalancer.html" class="">
      云平台 - 负载均衡器</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-d3df18c0319f8ea7ade159d66b647170" class="toggle"  />
    <label for="section-d3df18c0319f8ea7ade159d66b647170" class="flex">
      <a role="button" class="">
        网络编程</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/network/tcp-theory.html" class="">
      TCP原理</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>













</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>



  </div>
</aside>
 

    <div class="book-page">
      <header class="book-header hidden">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/icons/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>理解iptables</h3>

  <label for="toc-control">
    
    <img src="/icons/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#前提工作">前提工作</a></li>
    <li><a href="#网络传输">网络传输</a></li>
    <li><a href="#封包表头">封包表头</a></li>
    <li><a href="#封包格式">封包格式</a></li>
    <li><a href="#iptables中的表table">iptables中的表（table）</a></li>
    <li><a href="#表中的链chains">表中的链（chains）</a></li>
    <li><a href="#链中的规则rule">链中的规则（rule）</a></li>
    <li><a href="#iptables命令">iptables命令</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown book-article"><h1 id="理解iptables">理解iptables<a class="anchor" href="#%e7%90%86%e8%a7%a3iptables">#</a></h1>
<p>iptables是Linux系统中的一个命令，也是Linux系统上最常用的防火墙，我们常见的Linux发行版如：CentOS、Ubuntu等都是用iptables作为默认的防火墙，它的强大之处在于它可以控制所有进出系统的数据包。然而，对于初次接触它的人来说，这是个比较难用的命令，不止一个人问过我怎样写一条阻止某IP的命令，因为用它增加一条防火墙规则可能需要写一条很长的命令，如果你没有了解它的工作原理，是写不出一条完整的iptables命令的。本文将剖析它的工作原理并结合例子让你更容易使用它。</p>
<h2 id="前提工作">前提工作<a class="anchor" href="#%e5%89%8d%e6%8f%90%e5%b7%a5%e4%bd%9c">#</a></h2>
<p>要了解iptables就先要了解数据包，这里说的数据包指的是在网络中传输的数据包，又名：报文，如果你了解过TCP协议并写过相关的代码，那么这个词应该不会陌生，如果你不了也没关系，我们这就来谈一谈这个数据包的概念。</p>
<blockquote class='book-hint '>
<p>其实这个数据包的结构又要用到七层协议的概念，真是一环扣一环，这里我就且当你了解七层协议的概念，如果真的不懂可以先去看看《鸟哥的Linux私房菜》，不过我会尽量讲的通俗一些，希望这不会影响到你阅读下文。</p></blockquote><h2 id="网络传输">网络传输<a class="anchor" href="#%e7%bd%91%e7%bb%9c%e4%bc%a0%e8%be%93">#</a></h2>
<p>设有两台电脑A与B，A通过网络发送一个文件给B，这个文件会被切分成一个一个的小数据包，每个数据包大小约 1KB 左右，然后转成二进制码按顺序发出去，在网络中以电讯号的形式传输给B，B接收到以后再将这些二进制码转成数据包，最后组合成一个文件。</p>
<h2 id="封包表头">封包表头<a class="anchor" href="#%e5%b0%81%e5%8c%85%e8%a1%a8%e5%a4%b4">#</a></h2>
<p>数据包也称为封包，一个完整的封包，除了我们需要发送的内容以外还包含了很多额外信息，也就是封包表头，主要用来标记这个数据包“从哪里来到哪里去”，在上例中，如果AB相距较远的话，中间一般会经过多个路由器和交换机，当然还有网卡网线等。。。当一个封包经过途中每个设备时，这些设备都需要读出这些封包的表头，才能知道这个封包要去哪里，然后再发给对应的设备，下一个设备收到这个封包也是一样，最终到达了B，可以说封包表头与数据本身同等重要。</p>
<h2 id="封包格式">封包格式<a class="anchor" href="#%e5%b0%81%e5%8c%85%e6%a0%bc%e5%bc%8f">#</a></h2>
<p>实际上，每个数据包外面套了三层封包，每层都是不同的格式，用来给不同的设备读取。如果以TCP作为传输协议，这三层封包分别为：MAC封包、IP封包、TPC封包，用下图来说明它们的关系：
<img src="img/linux-resolve-iptables/linux-resolve-iptables_data-package.png" alt="" />
图中只是简单的列出每个封包表头中较关键的信息，其实还有很多其它信息，比如TCP封包表头中的序列号、状态码，每种封包的详细格式，这里就不展开说明了，不然的话就有点跑题了。如果想深入了解的话网上有很多相关资料。</p>
<h2 id="iptables中的表table">iptables中的表（table）<a class="anchor" href="#iptables%e4%b8%ad%e7%9a%84%e8%a1%a8table">#</a></h2>
<p>终于说到正点了，，iptables的原理正是分析每个封包的表头，然后根据我们设定的防火墙规则作出相应的动作。 在iptables中有表的概念，使用的时候一般用默认的表，需要的话也可以自己建表，在CentOS6.5中默认有四张表：filter、nat、mangle、raw，每张表有不同的作用:</p>
<ul>
<li><code>filter</code> 表的作用就是防火墙</li>
<li><code>nat</code> 表是用来作数据转发</li>
<li><code>mangle</code> 表专门对特定数据包进处理</li>
<li><code>raw</code> 表也是在特殊情况下用的，可以减少iptabls对性能的影响</li>
</ul>
<p>前两个表是常用的表，后两个用的很少，而且博主一直没有用过，本文只对前两个表进行介绍。</p>
<h2 id="表中的链chains">表中的链（chains）<a class="anchor" href="#%e8%a1%a8%e4%b8%ad%e7%9a%84%e9%93%bechains">#</a></h2>
<p>上面的每张表中都有多个链，链可以理解为小表，每个小表用来处理不同的情况，在filter表中，默认有三个小表：</p>
<ul>
<li><code>INPUT</code> 进入本机的封包要经过此链</li>
<li><code>OUTPUT</code> 从本机发出的封包要经过此链</li>
<li><code>FORWARD</code> 经过nat表后目标不是本机的封包会经过此链</li>
</ul>
<p>在nat表中，默认也有三个小表：</p>
<ul>
<li><code>PREROUTING</code> 封包进入本机时要先经过此链</li>
<li><code>POSTROUTING</code> 封包从本机发送出去之前要经过此链</li>
<li><code>OUTPUT</code> 经filter表过滤后的封包会经过此链</li>
</ul>
<p>由此可以看出，数据包在经过这些链时，是有先后顺序的，而且每张表也是有关联的，如果我们只考虑filter表和nat表，那么封包在通过iptables时的顺序大致如下： <img src="img/linux-resolve-iptables/linux-resolve-iptables_data-flow.png" alt="" /> 上图中需要注意的是，nat表中的PREROUTING链，nat是用来做数据转发的，它可以修改封包表头中的内容，假设我在PREROUTING链中写入一条规则：将目标为本机的封包转发到 <code>137.137.0.200</code> 这个IP上，这样当封包从PREROUTING链出来后，就不走图中的第二步，而是会经上图中的两条黄线，直接被送出本机。</p>
<h2 id="链中的规则rule">链中的规则（rule）<a class="anchor" href="#%e9%93%be%e4%b8%ad%e7%9a%84%e8%a7%84%e5%88%99rule">#</a></h2>
<p>每个小表中可以有多条规则，经过此小表的封包要符合此小表上的每条规则，最后才能通过，以filter表为例：</p>
<pre tabindex="0"><code>[root@blog ~]# iptables -t filter -n -L
Chain INPUT (policy DROP)
target     prot opt source               destination         
REJECT     all  --  191.96.249.0/24      0.0.0.0/0            reject-with icmp-port-unreachable
ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:22
ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:80
 
Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         
 
Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination </code></pre><p>命令说明：</p>
<ul>
<li><code>-t</code> 指定对哪个表进行操作，如果不指定，默认filter表</li>
<li><code>-n</code> 不要将IP地址转换为主机名</li>
<li><code>-L</code> 显示该表中的所有链与链中的规则</li>
</ul>
<p>上例中的命令列出来filter表中的详细情况，它有三个链：INPUT、FORWARD、OUTPUT，其中INPUT链中有7条规则，INPUT后面的括号中policy DROP表示默认不通过，当有数据包经过INPUT链时，会从第一条（从上往下的顺序）规则开始匹配，其中第一条表示拒绝所有来源为 <code>191.96.249.0</code> 这个网段的封包，当第一条不通过以后就不会再往下走了。</p>
<h2 id="iptables命令">iptables命令<a class="anchor" href="#iptables%e5%91%bd%e4%bb%a4">#</a></h2>
<p>要理解iptables，那么了解它的各个选项与参数也是很重要的。好了，我们来看一条命令：</p>
<pre tabindex="0"><code>[root@blog ~]# iptables -t filter -I INPUT -m mac --mac-source 6d:f5:27:8c:e2:7d -s 137.137.0.200 -d kxdmmr.com -p tcp --sport 1:65535 --dport 22 -j ACCEPT</code></pre><p>上面只是一个例子，一般不会写这么长啊，，，只是为了说明各参数的意义：</p>
<ul>
<li><code>-t</code> 对指定表进行操作，如：filter、nat</li>
<li><code>-I INPUT</code> 表示插入到INPUT链，对指定链进行插入操作，本条规则会被插入到INPUT链的最前面，也就是第一条，还有-A表示追加，-D表示删除，等等</li>
<li><code>-m</code> mac &ndash;mac-source 指定来源MAC地址</li>
<li><code>-s</code> 指定来源IP地址</li>
<li><code>-d</code> 指定目标IP地址</li>
<li><code>-p</code> 指定通信协议，如TCP、UDP、ICMP等，</li>
<li><code>--sport</code> 指定来源端口</li>
<li><code>--dport</code> 指定目标端口</li>
<li><code>-j</code> 指定动作，ACCEPT表示同意通过，DROP表示丢弃此封包，REJECT表示拒绝此封包</li>
</ul>
<p>所以，上面一条命令意义就是，在filter表中的INPUT链中最前面插入一条规则，作用是，让来源MAC地址为 <code>6d:f5:27:8c:e2:7d</code> 的，且来源IP为 <code>137.137.0.200</code> 的，且目标IP为本机的，且以TCP协议连接过来的，且来源端口是任意端口的，且目标端口为22的封包允许通过。 再来看一条数据转发的命令：</p>
<pre tabindex="0"><code>[root@blog ~]# iptables -t nat -A PREROUTING -d 137.137.0.100/32 ! -i lo -p tcp --dport 80 -j DNAT --to-destination 192.168.0.200:8080</code></pre><p>命令说明：</p>
<ul>
<li><code>-A</code> 将本条规则追加在PREROUTING链后面</li>
<li><code>-i</code> 指定网卡，本例中指：只匹配从lo这个网卡过来的封包</li>
<li><code>!</code> 表示非，本例中指：匹配lo这个网卡之外的所有其它网卡</li>
<li><code>--dport</code> 匹配目标端口为60030的封包</li>
<li><code>-j</code> 指定动作，DNAT表示修改此封包的目标IP，后面要跟 <code>–-to-destination</code> 参数。SNAT表示修改来源IP，后面要跟 <code>–-to-source</code> 参数</li>
<li><code>--to-destination</code> 将封包表头中的目标IP修改为此值</li>
</ul>
<p>所以，这条命令的意思是，在nat表中的PREROUTING链最后面追加一条规则，作用是，将目标IP为 <code>137.137.0.100</code> 的，且不是从lo这个网卡传进来的，且通信协议为tcp的，且目标端口为80的封包，转发到 <code>192.168.0.200</code> 这个IP的8080端口上。</p>
<p>通过上面的例子，你应该对它有一个比较完整的概念，并且很容易使用它。iptables还有更多参数可以用，这样看来，iptables貌似可以分析封包表头中的所有信息，让我们可以比较精准的对数据包进行控制。</p>
<p>-End-</p>
</article>
 
      <br/>
<hr/>


      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">

<div>

</div>

<div>

</div>

</div>



  



  
  
  
  <div class="flex flex-wrap justify-between">
    <span>
    
      <a href="/linux/linux-read-file-by-line.html" class="flex align-center">
        <img src="/icons/backward.svg" class="book-icon" alt="Previous" title="逐行读取文件的几种方法" />
        <span>逐行读取文件的几种方法</span>
      </a>
    
    </span>
    <span>
    
      <a href="/linux/linux-send-mail.html" class="flex align-center">
        <span>发送邮件的两种方式</span>
        <img src="/icons/forward.svg" class="book-icon" alt="Next" title="发送邮件的两种方式" />
      </a>
    
    </span>
  </div>
  




  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
  
  <div class="book-comments">

</div>
  
 
        <br/>


<div class="busuanzi-footer">
<span class="split"> · </span>
<span>
  <span id="busuanzi_container_page_pv">本文阅读量<span id="busuanzi_value_page_pv"></span>次</span>
</span>
<span class="split"> · </span>
  <span id="busuanzi_container_site_pv">
    本站总访问量<span id="busuanzi_value_site_pv"></span>次
  </span>
<span class="split"> · </span>
  <span id="busuanzi_container_site_uv">
    本站访客数<span id="busuanzi_value_site_uv"></span>人次
  </span>
</div>


<p><a href="http://creativecommons.org/licenses/by-nc-nd/3.0/cn/"><img src="https://licensebuttons.net/l/by-nc-nd/3.0/cn/88x31.png" /></a>
本站所有作品均采用<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/cn/">知识共享署名-非商业性使用-禁止演绎 3.0 中国大陆许可协议</a>进行许可。</p>

        

 
      </footer>

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    

<aside class="book-toc">
  <div class="book-toc-content">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#前提工作">前提工作</a></li>
    <li><a href="#网络传输">网络传输</a></li>
    <li><a href="#封包表头">封包表头</a></li>
    <li><a href="#封包格式">封包格式</a></li>
    <li><a href="#iptables中的表table">iptables中的表（table）</a></li>
    <li><a href="#表中的链chains">表中的链（chains）</a></li>
    <li><a href="#链中的规则rule">链中的规则（rule）</a></li>
    <li><a href="#iptables命令">iptables命令</a></li>
  </ul>
</nav>



  </div>
</aside>

 
  </main>

  
</body>
</html>



















<!DOCTYPE html>
<html lang="en" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="动态映射端口#
虽然设计者们一再地强调在使用Docker时要遵循最佳实践，但很多情况下并不能完全做到最佳实践，就比如我们现在的情况，是把Docker当做虚拟机来用，每个容器中包含了很多服务，，，当然，这也带来了很多问题，就比如：要映射很多的端口到物理机。
痛苦的映射问题#
在启动一个Docker容器时，可以指定-p参数来把容器内的端口映射到宿主机的IP端口上，这样可以很方便地从外界访问容器中的服务，一开始全都是用-p这种方式来做，如果容器中有10个端口需要映射到外面，那就指定10个-p选项，实际上可能更多，如下：
[root@blog ~]# docker run \
--name node1 \
-p 10.0.82.43:22:22 \
-p 10.0.82.43:8080:8080 \
-p 10.0.82.43:6066:6066 \
-p 10.0.82.43:7071:7071 \
-p 10.0.82.43:111:111 \
-p 10.0.82.43:5005:5005 \
-p 10.0.82.43:6265:6265 \
-p 10.0.82.43:7699:7699 \
...
-tid node-base 然后当docker ps的时候会看到整个屏幕被-p参数给占满了，，，好吧，这个不是问题，问题是如果在使用了很久后发现有一个端口没有映射出来！或者是你需要通过Java API远程调用容器中的程序，而又恰好没有映射那个端口，那该怎么办？
映射的实现#
其实Docker run命令中的-p选项，最终是通过宿主机上的iptables来实现的（也许你早就发现了，只是没有仔细研究），在Docker的宿主机上查看一下iptables的nat表，大概会看到下面这样：
[root@blog ~]# iptables -t nat -nvL
Chain PREROUTING (policy ACCEPT 1082K packets, 173M bytes)
 pkts bytes target     prot opt in     out     source               destination         
  637 37876 DNAT       tcp  --  *      *       0.0.0.0/0            10.100.124.231       tcp dpt:80 to:10.100.124.231:5000
 452K   27M DOCKER     all  --  *      *       0.0.0.0/0            0.0.0.0/0            ADDRTYPE match dst-type LOCAL
 
Chain INPUT (policy ACCEPT 267K packets, 29M bytes)
 pkts bytes target     prot opt in     out     source               destination         
 
Chain OUTPUT (policy ACCEPT 144K packets, 8644K bytes)
 pkts bytes target     prot opt in     out     source               destination         
26032 1563K DOCKER     all  --  *      *       0.0.0.0/0           !127.0.0.0/8          ADDRTYPE match dst-type LOCAL
 
Chain POSTROUTING (policy ACCEPT 144K packets, 8666K bytes)
 pkts bytes target     prot opt in     out     source               destination         
 108K 7893K MASQUERADE  all  --  *      !docker0  192.11.231.0/24      0.0.0.0/0          
91402 6409K MASQUERADE  all  --  *      !docker_gwbridge  192.12.231.0/24      0.0.0.0/0          
    0     0 MASQUERADE  tcp  --  *      *       192.11.231.2         192.11.231.2         tcp dpt:5000
    0     0 MASQUERADE  tcp  --  *      *       192.11.231.8         192.11.231.8         tcp dpt:8080
    0     0 MASQUERADE  tcp  --  *      *       192.11.231.8         192.11.231.8         tcp dpt:5005
 
Chain DOCKER (2 references)
 pkts bytes target     prot opt in     out     source               destination         
    4   264 RETURN     all  --  docker0 *       0.0.0.0/0            0.0.0.0/0          
    9   540 RETURN     all  --  docker_gwbridge *       0.0.0.0/0            0.0.0.0/0          
26315 1579K DNAT       tcp  --  !docker0 *       0.0.0.0/0            10.100.124.231       tcp dpt:5000 to:192.11.231.2:5000
    0     0 DNAT       tcp  --  !docker0 *       0.0.0.0/0            10.100.124.115       tcp dpt:8080 to:192.11.231.8:8080
    0     0 DNAT       tcp  --  !docker0 *       0.0.0.0/0            10.100.124.115       tcp dpt:5005 to:192.11.231.8:5005最主要最下面的DOCKER链，最后那三条规则就是在启动容器时指定了-p所导致的，那个5000端口你应该很熟悉，那是Register服务的端口号，我们可以通过它在局域网中上传和下载镜像，而且我在启动它的时候也只映射了这一个端口，如下：">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="http://localhost:1313/kubernetes/docker-dynamic-port-map.html">
  <meta property="og:site_name" content="橡果笔记">
  <meta property="og:title" content="橡果笔记">
  <meta property="og:description" content="动态映射端口# 虽然设计者们一再地强调在使用Docker时要遵循最佳实践，但很多情况下并不能完全做到最佳实践，就比如我们现在的情况，是把Docker当做虚拟机来用，每个容器中包含了很多服务，，，当然，这也带来了很多问题，就比如：要映射很多的端口到物理机。
痛苦的映射问题# 在启动一个Docker容器时，可以指定-p参数来把容器内的端口映射到宿主机的IP端口上，这样可以很方便地从外界访问容器中的服务，一开始全都是用-p这种方式来做，如果容器中有10个端口需要映射到外面，那就指定10个-p选项，实际上可能更多，如下：
[root@blog ~]# docker run \ --name node1 \ -p 10.0.82.43:22:22 \ -p 10.0.82.43:8080:8080 \ -p 10.0.82.43:6066:6066 \ -p 10.0.82.43:7071:7071 \ -p 10.0.82.43:111:111 \ -p 10.0.82.43:5005:5005 \ -p 10.0.82.43:6265:6265 \ -p 10.0.82.43:7699:7699 \ ... -tid node-base 然后当docker ps的时候会看到整个屏幕被-p参数给占满了，，，好吧，这个不是问题，问题是如果在使用了很久后发现有一个端口没有映射出来！或者是你需要通过Java API远程调用容器中的程序，而又恰好没有映射那个端口，那该怎么办？
映射的实现# 其实Docker run命令中的-p选项，最终是通过宿主机上的iptables来实现的（也许你早就发现了，只是没有仔细研究），在Docker的宿主机上查看一下iptables的nat表，大概会看到下面这样：
[root@blog ~]# iptables -t nat -nvL Chain PREROUTING (policy ACCEPT 1082K packets, 173M bytes) pkts bytes target prot opt in out source destination 637 37876 DNAT tcp -- * * 0.0.0.0/0 10.100.124.231 tcp dpt:80 to:10.100.124.231:5000 452K 27M DOCKER all -- * * 0.0.0.0/0 0.0.0.0/0 ADDRTYPE match dst-type LOCAL Chain INPUT (policy ACCEPT 267K packets, 29M bytes) pkts bytes target prot opt in out source destination Chain OUTPUT (policy ACCEPT 144K packets, 8644K bytes) pkts bytes target prot opt in out source destination 26032 1563K DOCKER all -- * * 0.0.0.0/0 !127.0.0.0/8 ADDRTYPE match dst-type LOCAL Chain POSTROUTING (policy ACCEPT 144K packets, 8666K bytes) pkts bytes target prot opt in out source destination 108K 7893K MASQUERADE all -- * !docker0 192.11.231.0/24 0.0.0.0/0 91402 6409K MASQUERADE all -- * !docker_gwbridge 192.12.231.0/24 0.0.0.0/0 0 0 MASQUERADE tcp -- * * 192.11.231.2 192.11.231.2 tcp dpt:5000 0 0 MASQUERADE tcp -- * * 192.11.231.8 192.11.231.8 tcp dpt:8080 0 0 MASQUERADE tcp -- * * 192.11.231.8 192.11.231.8 tcp dpt:5005 Chain DOCKER (2 references) pkts bytes target prot opt in out source destination 4 264 RETURN all -- docker0 * 0.0.0.0/0 0.0.0.0/0 9 540 RETURN all -- docker_gwbridge * 0.0.0.0/0 0.0.0.0/0 26315 1579K DNAT tcp -- !docker0 * 0.0.0.0/0 10.100.124.231 tcp dpt:5000 to:192.11.231.2:5000 0 0 DNAT tcp -- !docker0 * 0.0.0.0/0 10.100.124.115 tcp dpt:8080 to:192.11.231.8:8080 0 0 DNAT tcp -- !docker0 * 0.0.0.0/0 10.100.124.115 tcp dpt:5005 to:192.11.231.8:5005最主要最下面的DOCKER链，最后那三条规则就是在启动容器时指定了-p所导致的，那个5000端口你应该很熟悉，那是Register服务的端口号，我们可以通过它在局域网中上传和下载镜像，而且我在启动它的时候也只映射了这一个端口，如下：">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="kubernetes">
<title>动态映射端口 | 橡果笔记</title>
<link rel="icon" href="/favicon.png" >
<link rel="manifest" href="/manifest.json">
<link rel="canonical" href="http://localhost:1313/kubernetes/docker-dynamic-port-map.html">
<link rel="stylesheet" href="/book.min.c098be6fdb8410d437a0799e694b206fa639685582089c583ae6ac07afec1ff8.css" integrity="sha256-wJi&#43;b9uEENQ3oHmeaUsgb6Y5aFWCCJxYOuasB6/sH/g=" crossorigin="anonymous">


  <script defer src="/fuse.min.js"></script>
  <script defer src="/en.search.min.15cd00d37558f9ebf065bde007abdfcffc678c14a90007173321781d2d1696e0.js" integrity="sha256-Fc0A03VY&#43;evwZb3gB6vfz/xnjBSpAAcXMyF4HS0WluA=" crossorigin="anonymous"></script>

  <script
  async
  src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"
></script>
<meta name="referrer" content="no-referrer-when-downgrade" />
</head>
<body dir="ltr" class="book-kind-page book-type-kubernetes">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    
<aside class="book-menu">
  <div class="book-menu-content">
    
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/index.html"><img src="/favicon.png" alt="Logo" /><span>橡果笔记</span>
  </a>
</h2>


<div class="book-search hidden">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>












  



  
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-c43281baae2cfc496810cc1f0d196095" class="toggle"  />
    <label for="section-c43281baae2cfc496810cc1f0d196095" class="flex">
      <a role="button" class="">
        Atlas Case</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11111.html" class="">
      11111</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11112.html" class="">
      11112</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11113.html" class="">
      11113</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11114.html" class="">
      11114</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11115.html" class="">
      11115</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11116.html" class="">
      11116</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11117.html" class="">
      11117</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11118.html" class="">
      11118</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11119.html" class="">
      11119</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11120.html" class="">
      11120</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11121.html" class="">
      11121</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11122.html" class="">
      11122</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11123.html" class="">
      11123</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11124.html" class="">
      11124</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11125.html" class="">
      11125</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11126.html" class="">
      11126</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11127.html" class="">
      11127</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11128.html" class="">
      11128</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11129.html" class="">
      11129</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/atlas-case/11130.html" class="">
      11130</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-12d4232cf896b89b6af3619d86f786b1" class="toggle"  />
    <label for="section-12d4232cf896b89b6af3619d86f786b1" class="flex">
      <a role="button" class="">
        Golang</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/golang/find-index-in-cycle-array.html" class="">
      在循环数组中找出索引</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/golang/golang-get-package-to-dir.html" class="">
      下载包到指定目录</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/golang/golang-grpc-demo.html" class="">
      gRPC使用指南</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/golang/golang-profiler.html" class="">
      应用性能分析</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/golang/golang-regexp-performance.html" class="">
      正则性能优化</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/golang/golang-tls-web.html" class="">
      web应用开发</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/golang/golang-web-and-curl.html" class="">
      解析客户端参数</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/golang/unicode-to-zh.html" class="">
      unicode转中文</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-b0c7fc0f44fa6f9b2b6b2aaa166d103d" class="toggle"  />
    <label for="section-b0c7fc0f44fa6f9b2b6b2aaa166d103d" class="flex">
      <a role="button" class="">
        Java</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/java/java-from-class-to-machine-code.html" class="">
      Java - 从CLASS到机器码</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/java/java-nio-frame.html" class="">
      Java - NIO框架</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/java/netty-guide.html" class="">
      Java - Netty入门</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-1fba834cea86f65b73a207a4c7222a69" class="toggle"  />
    <label for="section-1fba834cea86f65b73a207a4c7222a69" class="flex">
      <a role="button" class="">
        Linux</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/linux/linux-centos7-multi-ip.html" class="">
      Centos7增加子IP</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/linux/linux-parallel-progress.html" class="">
      炫酷的并行进度条</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/linux/linux-pipe-redirect.html" class="">
      管道与重定向详解</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/linux/linux-read-file-by-line.html" class="">
      逐行读取文件的几种方法</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/linux/linux-resolve-iptables.html" class="">
      理解iptables</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/linux/linux-send-mail.html" class="">
      发送邮件的两种方式</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-a678cfd4d00720650628dd6c008f4ee1" class="toggle"  />
    <label for="section-a678cfd4d00720650628dd6c008f4ee1" class="flex">
      <a role="button" class="">
        健康管理</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-d037bff0aa1de2c37d870a73480bbe84" class="toggle"  />
    <label for="section-d037bff0aa1de2c37d870a73480bbe84" class="flex">
      <a role="button" class="">
        大数据</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/bigdata/ambari-quick-build-bigdata-platform.html" class="">
      Ambari - 三条命令创建集群</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/bigdata/bigdate-on-docker.html" class="">
      Bigdata on Docker</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/bigdata/bigdate-on-kubernetes.html" class="">
      Bigdata on Kubernetes</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/bigdata/spark-performance-optimiz.html" class="">
      Spark on Yarn - 性能调优</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/bigdata/spark-performance-test.html" class="">
      Spark - 性能测试</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/bigdata/spark-source-code-1.html" class="">
      Spark - 源码分析（一）</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/bigdata/spark-source-code-2.html" class="">
      Spark - 源码分析（二）</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/bigdata/spark-source-code-3.html" class="">
      Spark - 源码分析（三）</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/bigdata/spark-source-code-4.html" class="">
      Spark – 源码分析（四）</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/bigdata/spark-source-code-5.html" class="">
      Spark - 源码分析（图）</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/bigdata/spark-thrift-mode.html" class="">
      Spark - Thrift Server模式</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-91c0d79a971e1d12f575b6033d9c8855" class="toggle" checked />
    <label for="section-91c0d79a971e1d12f575b6033d9c8855" class="flex">
      <a role="button" class="">
        容器开发</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-auto-test-product.html" class="">
      产品自动化测试</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-bigdata-develope.html" class="">
      与大数据平台开发</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-build-centos65.html" class="">
      手工构建基础镜像</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-code-create-container.html" class="">
      DOCKER源码-创建容器</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-code-create-network.html" class="">
      DOCKER源码-创建网络</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-code-start-dockerd.html" class="">
      DOCKER源码-启动流程</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-config-direct-lvm.html" class="">
      配置direct-lvm</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-dynamic-port-map.html" class="active">
      动态映射端口</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-multi-host-with-zk.html" class="">
      多主机通信之ZK</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-registry-deploy-manage.html" class="">
      私有仓库的搭建与管理</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/docker-with-glusterfs.html" class="">
      数据持久化之GlusterFS</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/k8s-calico.html" class="">
      calico网络</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/k8s-cni.html" class="">
      k8s CNI</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/k8s-code-apiserver-start.html" class="">
      k8s源码分析-apiserver</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/k8s-code-kubelet.html" class="">
      k8s源码分析-kubelet</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/k8s-code-pod-create.html" class="">
      k8s源码分析-创建Pod流程</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/k8s-code-scheduler-start.html" class="">
      k8s源码分析-scheduler</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/k8s-cri.html" class="">
      k8s CRI</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/k8s-dashboard-with-heapster.html" class="">
      k8s 仪表盘与性能指标</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/k8s-expose-service.html" class="">
      k8s 暴露服务</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/k8s-principle.html" class="">
      k8s 基本原理</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/kubeedge-code.html" class="">
      KubeEdge源码分析</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/kubernetes-quick-deloy-17.html" class="">
      k8s 快速部署 1.7</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/kubernetes-quick-deloy.html" class="">
      k8s 快速部署 1.5</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/kubernetes/popular-bgp-protocol.html" class="">
      白话BGP协议</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-c5d12fc3b068a833366514cb64f8d255" class="toggle"  />
    <label for="section-c5d12fc3b068a833366514cb64f8d255" class="flex">
      <a role="button" class="">
        开发工具</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/develop-tool/git.html" class="">
      GIT常用命令</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/develop-tool/jq.html" class="">
      JQ命令</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/develop-tool/vscode.html" class="">
      vscode for go</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-6149a7124e796953d79adfd27cbd4453" class="toggle"  />
    <label for="section-6149a7124e796953d79adfd27cbd4453" class="flex">
      <a role="button" class="">
        数据结构与算法</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/algorithm/algorithm-collaborative-filtering.html" class="">
      推荐算法 - 协同过滤</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/algorithm/algorithm-naive-bayes.html" class="">
      分类算法 - 朴素贝叶斯</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/algorithm/algorithm-quick-sort.html" class="">
      排序算法 - 快速排序</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-67c69527106b60d0276c1da79ec8b117" class="toggle"  />
    <label for="section-67c69527106b60d0276c1da79ec8b117" class="flex">
      <a role="button" class="">
        架构设计</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/architecture/cloud-plateform-loadbalancer.html" class="">
      云平台 - 负载均衡器</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-d3df18c0319f8ea7ade159d66b647170" class="toggle"  />
    <label for="section-d3df18c0319f8ea7ade159d66b647170" class="flex">
      <a role="button" class="">
        网络编程</a>
      <img src="/icons/chevron-right.svg" class="book-icon" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/network/tcp-theory.html" class="">
      TCP原理</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>













</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>



  </div>
</aside>
 

    <div class="book-page">
      <header class="book-header hidden">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/icons/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>动态映射端口</h3>

  <label for="toc-control">
    
    <img src="/icons/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#痛苦的映射问题">痛苦的映射问题</a></li>
    <li><a href="#映射的实现">映射的实现</a></li>
    <li><a href="#动态映射">动态映射</a></li>
    <li><a href="#换一种映射方式">换一种映射方式</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown book-article"><h1 id="动态映射端口">动态映射端口<a class="anchor" href="#%e5%8a%a8%e6%80%81%e6%98%a0%e5%b0%84%e7%ab%af%e5%8f%a3">#</a></h1>
<p>虽然设计者们一再地强调在使用Docker时要遵循最佳实践，但很多情况下并不能完全做到最佳实践，就比如我们现在的情况，是把Docker当做虚拟机来用，每个容器中包含了很多服务，，，当然，这也带来了很多问题，就比如：要映射很多的端口到物理机。</p>
<h2 id="痛苦的映射问题">痛苦的映射问题<a class="anchor" href="#%e7%97%9b%e8%8b%a6%e7%9a%84%e6%98%a0%e5%b0%84%e9%97%ae%e9%a2%98">#</a></h2>
<p>在启动一个Docker容器时，可以指定-p参数来把容器内的端口映射到宿主机的IP端口上，这样可以很方便地从外界访问容器中的服务，一开始全都是用-p这种方式来做，如果容器中有10个端口需要映射到外面，那就指定10个-p选项，实际上可能更多，如下：</p>
<pre tabindex="0"><code>[root@blog ~]# docker run \
--name node1 \
-p 10.0.82.43:22:22 \
-p 10.0.82.43:8080:8080 \
-p 10.0.82.43:6066:6066 \
-p 10.0.82.43:7071:7071 \
-p 10.0.82.43:111:111 \
-p 10.0.82.43:5005:5005 \
-p 10.0.82.43:6265:6265 \
-p 10.0.82.43:7699:7699 \
...
-tid node-base </code></pre><p>然后当docker ps的时候会看到整个屏幕被-p参数给占满了，，，好吧，这个不是问题，问题是如果在使用了很久后发现有一个端口没有映射出来！或者是你需要通过Java API远程调用容器中的程序，而又恰好没有映射那个端口，那该怎么办？</p>
<h2 id="映射的实现">映射的实现<a class="anchor" href="#%e6%98%a0%e5%b0%84%e7%9a%84%e5%ae%9e%e7%8e%b0">#</a></h2>
<p>其实Docker run命令中的-p选项，最终是通过宿主机上的iptables来实现的（也许你早就发现了，只是没有仔细研究），在Docker的宿主机上查看一下iptables的nat表，大概会看到下面这样：</p>
<pre tabindex="0"><code>[root@blog ~]# iptables -t nat -nvL
Chain PREROUTING (policy ACCEPT 1082K packets, 173M bytes)
 pkts bytes target     prot opt in     out     source               destination         
  637 37876 DNAT       tcp  --  *      *       0.0.0.0/0            10.100.124.231       tcp dpt:80 to:10.100.124.231:5000
 452K   27M DOCKER     all  --  *      *       0.0.0.0/0            0.0.0.0/0            ADDRTYPE match dst-type LOCAL
 
Chain INPUT (policy ACCEPT 267K packets, 29M bytes)
 pkts bytes target     prot opt in     out     source               destination         
 
Chain OUTPUT (policy ACCEPT 144K packets, 8644K bytes)
 pkts bytes target     prot opt in     out     source               destination         
26032 1563K DOCKER     all  --  *      *       0.0.0.0/0           !127.0.0.0/8          ADDRTYPE match dst-type LOCAL
 
Chain POSTROUTING (policy ACCEPT 144K packets, 8666K bytes)
 pkts bytes target     prot opt in     out     source               destination         
 108K 7893K MASQUERADE  all  --  *      !docker0  192.11.231.0/24      0.0.0.0/0          
91402 6409K MASQUERADE  all  --  *      !docker_gwbridge  192.12.231.0/24      0.0.0.0/0          
    0     0 MASQUERADE  tcp  --  *      *       192.11.231.2         192.11.231.2         tcp dpt:5000
    0     0 MASQUERADE  tcp  --  *      *       192.11.231.8         192.11.231.8         tcp dpt:8080
    0     0 MASQUERADE  tcp  --  *      *       192.11.231.8         192.11.231.8         tcp dpt:5005
 
Chain DOCKER (2 references)
 pkts bytes target     prot opt in     out     source               destination         
    4   264 RETURN     all  --  docker0 *       0.0.0.0/0            0.0.0.0/0          
    9   540 RETURN     all  --  docker_gwbridge *       0.0.0.0/0            0.0.0.0/0          
26315 1579K DNAT       tcp  --  !docker0 *       0.0.0.0/0            10.100.124.231       tcp dpt:5000 to:192.11.231.2:5000
    0     0 DNAT       tcp  --  !docker0 *       0.0.0.0/0            10.100.124.115       tcp dpt:8080 to:192.11.231.8:8080
    0     0 DNAT       tcp  --  !docker0 *       0.0.0.0/0            10.100.124.115       tcp dpt:5005 to:192.11.231.8:5005</code></pre><p>最主要最下面的DOCKER链，最后那三条规则就是在启动容器时指定了-p所导致的，那个5000端口你应该很熟悉，那是Register服务的端口号，我们可以通过它在局域网中上传和下载镜像，而且我在启动它的时候也只映射了这一个端口，如下：</p>
<pre tabindex="0"><code>[root@blog ~]# docker ps -f name=repo
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                           NAMES
867106b006da        registry:2          &#34;/entrypoint.sh /etc/&#34;   4 months ago        Up 4 months         10.100.124.231:5000-&gt;5000/tcp   repo</code></pre><p>跟前面的提到的三条规则对比一下，是不是明白了？iptables把从10.100.124.231:5000这个端口过来的数据转发给了192.11.231.2:5000，其中192.11.231.2就是repo容器的IP。</p>
<h2 id="动态映射">动态映射<a class="anchor" href="#%e5%8a%a8%e6%80%81%e6%98%a0%e5%b0%84">#</a></h2>
<p>现在我们就用它来说明好了，假设在repo这个容器中还有一个httpd服务并且监听着8080端口，那我要怎样才能从外面访问它呢？其实很简单啊，在宿机上增加一条iptables规则就可以了，如下：</p>
<pre tabindex="0"><code>[root@blog ~]# iptables -t nat -A DOCKER -d 10.100.124.231/32 ! -i docker0 -p tcp -m tcp --dport 8080 -j DNAT --to-destination 192.11.231.2:8080</code></pre><p>再看下iptables中的规则：</p>
<pre tabindex="0"><code>[root@blog ~]# iptables -t nat -nvL
...    #前面省略掉
Chain DOCKER (2 references)
 pkts bytes target     prot opt in     out     source               destination         
    4   264 RETURN     all  --  docker0 *       0.0.0.0/0            0.0.0.0/0          
    9   540 RETURN     all  --  docker_gwbridge *       0.0.0.0/0            0.0.0.0/0          
26315 1579K DNAT       tcp  --  !docker0 *       0.0.0.0/0            10.100.124.231       tcp dpt:5000 to:192.11.231.2:5000
    0     0 DNAT       tcp  --  !docker0 *       0.0.0.0/0            10.100.124.115       tcp dpt:8080 to:192.11.231.8:8080
    0     0 DNAT       tcp  --  !docker0 *       0.0.0.0/0            10.100.124.115       tcp dpt:5005 to:192.11.231.8:5005
    0     0 DNAT       tcp  --  !docker0 *       0.0.0.0/0            10.100.124.231       tcp dpt:8080 to:192.11.231.2:8080</code></pre><p>现在已经可以通过10.100.124.231:8080来访问repo容器内的httpd服务了，当然了，可以增加就可以删除啊，只要把前面那条增加命令中的-A换成-D就可以了。。</p>
<h2 id="换一种映射方式">换一种映射方式<a class="anchor" href="#%e6%8d%a2%e4%b8%80%e7%a7%8d%e6%98%a0%e5%b0%84%e6%96%b9%e5%bc%8f">#</a></h2>
<p>后来想，既然可以动态映射，那-p选项是不是就可以省略掉了？？So，后来在启动容器时，启动命令就变成这样了：</p>
<pre tabindex="0"><code>[root@blog ~]# docker run \
--name node1 \
-p 10.0.82.43:22:22 \
-tid node-base 
[root@blog ~]# con_ip=`docker inspect --format=&#39;{{.NetworkSettings.Networks.bridge.IPAddress}}&#39; node1`
[root@blog ~]# iptables -t nat -A DOCKER -d 10.0.82.43/32 ! -i docker0 -p tcp -m tcp --dport 1025:62000 -j DNAT --to-destination $con_ip</code></pre><p>就是在启动容器的时候只映射一个端口出来，然后通过命令得到这个容器的IP，最后在宿主机上用iptables将容器的所有端口都映射出来，干净利落，又省去了很多麻烦。</p>
<p>-End-</p>
</article>
 
      <br/>
<hr/>


      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">

<div>

</div>

<div>

</div>

</div>



  



  
  
  
  <div class="flex flex-wrap justify-between">
    <span>
    
      <a href="/kubernetes/docker-config-direct-lvm.html" class="flex align-center">
        <img src="/icons/backward.svg" class="book-icon" alt="Previous" title="配置direct-lvm" />
        <span>配置direct-lvm</span>
      </a>
    
    </span>
    <span>
    
      <a href="/kubernetes/docker-multi-host-with-zk.html" class="flex align-center">
        <span>多主机通信之ZK</span>
        <img src="/icons/forward.svg" class="book-icon" alt="Next" title="多主机通信之ZK" />
      </a>
    
    </span>
  </div>
  




  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
  
  <div class="book-comments">

</div>
  
 
        <br/>


<div class="busuanzi-footer">
<span class="split"> · </span>
<span>
  <span id="busuanzi_container_page_pv">本文阅读量<span id="busuanzi_value_page_pv"></span>次</span>
</span>
<span class="split"> · </span>
  <span id="busuanzi_container_site_pv">
    本站总访问量<span id="busuanzi_value_site_pv"></span>次
  </span>
<span class="split"> · </span>
  <span id="busuanzi_container_site_uv">
    本站访客数<span id="busuanzi_value_site_uv"></span>人次
  </span>
</div>


<p><a href="http://creativecommons.org/licenses/by-nc-nd/3.0/cn/"><img src="https://licensebuttons.net/l/by-nc-nd/3.0/cn/88x31.png" /></a>
本站所有作品均采用<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/cn/">知识共享署名-非商业性使用-禁止演绎 3.0 中国大陆许可协议</a>进行许可。</p>

        

 
      </footer>

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    

<aside class="book-toc">
  <div class="book-toc-content">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#痛苦的映射问题">痛苦的映射问题</a></li>
    <li><a href="#映射的实现">映射的实现</a></li>
    <li><a href="#动态映射">动态映射</a></li>
    <li><a href="#换一种映射方式">换一种映射方式</a></li>
  </ul>
</nav>



  </div>
</aside>

 
  </main>

  
</body>
</html>


















